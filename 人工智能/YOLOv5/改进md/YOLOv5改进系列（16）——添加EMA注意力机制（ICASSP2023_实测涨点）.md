![](https://i-blog.csdnimg.cn/blog_migrate/e2836096f998f3ccea99496ba074746c.gif)

![](https://i-blog.csdnimg.cn/blog_migrate/50a5fc7231e6c8d25ae09488ce414c27.png) ![962f7cb1b48f44e29d9beb1d499d0530.gif](https://i-blog.csdnimg.cn/blog_migrate/ac3c5d6bfbcbf982e8e9e3632d7f20d1.gif)ã€YOLOv5æ”¹è¿›ç³»åˆ—ã€‘å‰æœŸå›é¡¾ï¼š

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ0ï¼‰â€”â€”é‡è¦æ€§èƒ½æŒ‡æ ‡ä¸è®­ç»ƒç»“æœè¯„ä»·åŠåˆ†æ][YOLOv5_0]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ1ï¼‰â€”â€”æ·»åŠ SEæ³¨æ„åŠ›æœºåˆ¶][YOLOv5_1_SE]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ2ï¼‰â€”â€”æ·»åŠ CBAMæ³¨æ„åŠ›æœºåˆ¶][YOLOv5_2_CBAM]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ3ï¼‰â€”â€”æ·»åŠ CAæ³¨æ„åŠ›æœºåˆ¶][YOLOv5_3_CA]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ4ï¼‰â€”â€”æ·»åŠ ECAæ³¨æ„åŠ›æœºåˆ¶][YOLOv5_4_ECA]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ5ï¼‰â€”â€”æ›¿æ¢ä¸»å¹²ç½‘ç»œä¹‹ MobileNetV3][YOLOv5_5_ MobileNetV3]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ6ï¼‰â€”â€”æ›¿æ¢ä¸»å¹²ç½‘ç»œä¹‹ ShuffleNetV2][YOLOv5_6_ ShuffleNetV2]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ7ï¼‰â€”â€”æ·»åŠ SimAMæ³¨æ„åŠ›æœºåˆ¶][YOLOv5_7_SimAM]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ8ï¼‰â€”â€”æ·»åŠ SOCAæ³¨æ„åŠ›æœºåˆ¶][YOLOv5_8_SOCA]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ9ï¼‰â€”â€”æ›¿æ¢ä¸»å¹²ç½‘ç»œä¹‹EfficientNetv2][YOLOv5_9_EfficientNetv2]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ10ï¼‰â€”â€”æ›¿æ¢ä¸»å¹²ç½‘ç»œä¹‹GhostNet][YOLOv5_10_GhostNet]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ11ï¼‰â€”â€”æ·»åŠ æŸå¤±å‡½æ•°ä¹‹EIoUã€AlphaIoUã€SIoUã€WIoU][YOLOv5_11_EIoU_AlphaIoU_SIoU_WIoU]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ12ï¼‰â€”â€”æ›´æ¢Neckä¹‹BiFPN][YOLOv5_12_Neck_BiFPN]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ13ï¼‰â€”â€”æ›´æ¢æ¿€æ´»å‡½æ•°ä¹‹SiLUï¼ŒReLUï¼ŒELUï¼ŒHardswishï¼ŒMishï¼ŒSoftplusï¼ŒAconCç³»åˆ—ç­‰][YOLOv5_13_SiLU_ReLU_ELU_Hardswish_Mish_Softplus_AconC]

[YOLOv5æ”¹è¿›ç³»åˆ—ï¼ˆ14ï¼‰â€”â€”æ›´æ¢NMSï¼ˆéæå¤§æŠ‘åˆ¶ï¼‰ä¹‹ DIoU-NMSã€CIoU-NMSã€EIoU-NMSã€GIoU-NMS ã€SIoU-NMSã€Soft-NMS][YOLOv5_14_NMS_ DIoU-NMS_CIoU-NMS_EIoU-NMS_GIoU-NMS _SIoU-NMS_Soft-NMS]

![](https://i-blog.csdnimg.cn/blog_migrate/6e7df20d56b4203546bb53ba6b10bb0e.gif)

ç›®å½•

[ ğŸš€ä¸€ã€EMAä»‹ç» ][_EMA_]

[1.1 ç®€ä»‹][1.1]

[ğŸš€äºŒã€åœ¨Neckç«¯æ·»åŠ EMAæ³¨æ„åŠ›æœºåˆ¶æ–¹æ³•][Neck_EMA]

[2.1 æ·»åŠ é¡ºåº ][2.1 _]

[2.2 å…·ä½“æ·»åŠ æ­¥éª¤ ][2.2 _]

[ç¬¬â‘ æ­¥ï¼šåœ¨common.pyä¸­æ·»åŠ EMAæ¨¡å—][common.py_EMA]

[ç¬¬â‘¡æ­¥ï¼šåœ¨yolo.pyæ–‡ä»¶é‡Œçš„parse\_modelå‡½æ•°åŠ å…¥ç±»å][yolo.py_parse_model]

[ç¬¬â‘¢æ­¥ï¼šåˆ›å»ºè‡ªå®šä¹‰çš„yamlæ–‡ä»¶ ][yaml_]

[ç¬¬â‘£æ­¥ï¼šéªŒè¯æ˜¯å¦åŠ å…¥æˆåŠŸ][Link 1]

[ç¬¬â‘¤æ­¥ï¼šä¿®æ”¹train.pyä¸­ â€˜--cfgâ€™é»˜è®¤å‚æ•°][train.py_ _--cfg]

[ ğŸš€ä¸‰ã€åœ¨C3ä¸­æ·»åŠ EMAæ³¨æ„åŠ›æœºåˆ¶æ–¹æ³•][_C3_EMA]

[3.1 å…·ä½“æ·»åŠ æ­¥éª¤][3.1]

[ç¬¬â‘ æ­¥ï¼šåœ¨common.pyä¸­æ·»åŠ C3\_EMAæ¨¡å—][common.py_C3_EMA]

[ç¬¬â‘¡æ­¥ï¼šåœ¨yolo.pyæ–‡ä»¶é‡Œçš„parse\_modelå‡½æ•°åŠ å…¥ç±»å][yolo.py_parse_model 1]

[ç¬¬â‘¢æ­¥ï¼šåˆ›å»ºè‡ªå®šä¹‰çš„yamlæ–‡ä»¶ ][yaml_]

[ç¬¬â‘£æ­¥ï¼šéªŒè¯æ˜¯å¦åŠ å…¥æˆåŠŸ][Link 2]

[ç¬¬â‘¤æ­¥ï¼šä¿®æ”¹train.pyä¸­ â€˜--cfgâ€™é»˜è®¤å‚æ•°][train.py_ _--cfg]

[ğŸŒŸæœ¬äººYOLOv5ç³»åˆ—å¯¼èˆª][YOLOv5]

![](https://i-blog.csdnimg.cn/blog_migrate/223b8b788845505bb310462ef23fa279.gif)

## ğŸš€ä¸€ã€EMAä»‹ç» 

>  *  è®ºæ–‡é¢˜ç›®ï¼šã€ŠEfficient Multi-Scale Attention Module with Cross-Spatial Learningã€‹
>  *  åŸæ–‡é“¾æ¥ï¼š[\[2305.13563v1\] Efficient Multi-Scale Attention Module with Cross-Spatial Learning (arxiv.org)][2305.13563v1_ Efficient Multi-Scale Attention Module with Cross-Spatial Learning _arxiv.org]

### 1.1 ç®€ä»‹ 

é€šé“æˆ–ç©ºé—´çš„æ˜¾è‘—æœ‰æ•ˆæ€§æ³¨æ„æœºåˆ¶å¯¹äº§ç”Ÿæ›´å¤šå¯è¾¨è¯†çš„ç‰¹å¾è¡¨ç¤ºçš„æ˜¾è‘—æ•ˆæœï¼Œç„¶è€Œç”¨é€šé“é™ç»´å¯¹è·¨é€šé“å…³ç³»è¿›è¡Œå»ºæ¨¡å…³ç³»ï¼Œå¯èƒ½ä¼šç»™æå–æ·±å±‚è§†è§‰è¡¨å¾å¸¦æ¥å‰¯ä½œç”¨ã€‚æ¯”å¦‚CAæ³¨æ„åŠ›æœºåˆ¶ï¼Œè™½å¯¹ç²¾åº¦æœ‰ä¸€å®šçš„æå‡ä½†æ˜¯ç”±äºéœ€è¦å¯¹æ•´ä¸ªç‰¹å¾å›¾è¿›è¡Œæ³¨æ„åŠ›æƒé‡çš„è®¡ç®—ï¼Œå› æ­¤éœ€è¦é¢å¤–çš„è®¡ç®—å¯¼è‡´æ¶ˆè€—èµ„æºï¼Œå¦å¤–æ— æ³•æ•æ‰é€šé“ä¹‹é—´é•¿è·ç¦»çš„ä¾èµ–å…³ç³»ã€‚  
æ·±åœ³çš„èˆªå¤©ç§‘å·¥2023å¹´6æœˆæå‡ºçš„æ–°å‹çš„é«˜æ•ˆå¤šå°ºåº¦æ³¨æ„åŠ›EMAæ¨¡å—ï¼Œè¯¥æ¨¡å—é¦–å…ˆå°†éƒ¨åˆ†é€šé“ç»´åº¦é‡å¡‘ä¸ºæ‰¹é‡ç»´åº¦ï¼Œä»¥é¿å…é€šç”¨å·ç§¯è¿›è¡ŒæŸç§å½¢å¼çš„é™ç»´ï¼›æ¥ç€åœ¨æ¯ä¸ªå¹¶è¡Œå­ç½‘ç»œä¸­æ„å»ºå±€éƒ¨çš„è·¨é€šé“äº¤äº’ï¼Œåˆ©ç”¨ä¸€ç§æ–°çš„è·¨ç©ºé—´å­¦ä¹ æ–¹æ³•èåˆä¸¤ä¸ªå¹¶è¡Œå­ç½‘ç»œçš„è¾“å‡ºç‰¹å¾å›¾ï¼Œè®¾è®¡äº†ä¸€ä¸ªå¤šå°ºåº¦å¹¶è¡Œå­ç½‘ç»œæ¥å»ºç«‹çŸ­å’Œé•¿ä¾èµ–å…³ç³»ã€‚EMAçš„ç½‘ç»œç»“æ„å›¾å¦‚å›¾æ‰€ç¤ºã€‚

![](https://i-blog.csdnimg.cn/blog_migrate/6f8a54d5e4728326c5cfc0e0222265f9.png)

## ğŸš€äºŒã€åœ¨Neckç«¯æ·»åŠ EMAæ³¨æ„åŠ›æœºåˆ¶æ–¹æ³• 

### 2.1 æ·»åŠ é¡ºåº 

ï¼ˆ1ï¼‰models/common.py \--> åŠ å…¥æ–°å¢çš„ç½‘ç»œç»“æ„

ï¼ˆ2ï¼‰ models/yolo.py  \--> è®¾å®šç½‘ç»œç»“æ„çš„ä¼ å‚ç»†èŠ‚ï¼Œå°†EMAç±»ååŠ å…¥å…¶ä¸­ã€‚ï¼ˆå½“æ–°çš„è‡ªå®šä¹‰æ¨¡å—ä¸­å­˜åœ¨è¾“å…¥è¾“å‡ºç»´åº¦æ—¶ï¼Œè¦ä½¿ç”¨qwè°ƒæ•´è¾“å‡ºç»´åº¦ï¼‰  
ï¼ˆ3ï¼‰ models/yolov5\*.yaml  \--> æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå¦‚yolov5s\_EMA.yamlï¼Œä¿®æ”¹ç°æœ‰æ¨¡å‹ç»“æ„é…ç½®æ–‡ä»¶ã€‚ï¼ˆå½“å¼•å…¥æ–°çš„å±‚æ—¶ï¼Œè¦ä¿®æ”¹åç»­çš„ç»“æ„ä¸­çš„fromå‚æ•°ï¼‰  
ï¼ˆ4ï¼‰ train.py  \--> ä¿®æ”¹â€˜--cfgâ€™é»˜è®¤å‚æ•°ï¼Œè®­ç»ƒæ—¶æŒ‡å®šæ¨¡å‹ç»“æ„é…ç½®æ–‡ä»¶

### 2.2 å…·ä½“æ·»åŠ æ­¥éª¤ 

#### ç¬¬â‘ æ­¥ï¼šåœ¨common.pyä¸­æ·»åŠ EMAæ¨¡å— 

ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡ä¸CAç±»ä¼¼çš„å¤„ç†ï¼Œå°†ä¸¤ä¸ªç¼–ç ç‰¹å¾è¿æ¥åœ¨å›¾åƒé«˜åº¦æ–¹å‘ä¸Šï¼Œå¹¶ä½¿å…¶å…±äº«ç›¸åŒçš„1Ã—1å·ç§¯ï¼Œè€Œä¸ä¼šé™ä½1x1åˆ†æ”¯çš„ç»´æ•°ã€‚åœ¨å°†1x1å·ç§¯çš„è¾“å‡ºåˆ†è§£ä¸º2ä¸ªå‘é‡åï¼Œä½¿ç”¨ä¸¤ä¸ªéçº¿æ€§Sigmidå‡½æ•°æ¥æ‹Ÿåˆçº¿æ€§å·ç§¯ä¸Šçš„2DäºŒè¿›åˆ¶åˆ†å¸ƒã€‚ä¸ºäº†åœ¨1Ã—1åˆ†æ”¯ä¸­çš„ä¸¤ä¸ªå¹³è¡Œè·¯çº¿ä¹‹é—´å®ç°ä¸åŒçš„è·¨é€šé“äº¤äº’ç‰¹å¾ï¼Œé€šè¿‡ç®€å•çš„ä¹˜æ³•å°†æ¯ç»„å†…çš„ä¸¤ä¸ªé€šé“æ³¨æ„åŠ›å›¾èšåˆåœ¨ä¸€èµ·ã€‚

![](https://i-blog.csdnimg.cn/blog_migrate/095406f24294854f4e73d8ac48ae50a8.png)

ç¬¬äºŒæ­¥ï¼Œ3Ã—3åˆ†æ”¯é€šè¿‡å·ç§¯æ•è·å±€éƒ¨è·¨é€šé“äº¤äº’ï¼Œä»¥æ‰©å¤§ç‰¹å¾ç©ºé—´ã€‚

![](https://i-blog.csdnimg.cn/blog_migrate/03a2884434ce8970450d3c84a5315074.png)

è¿™æ ·ï¼ŒEMAä¸ä»…å¯¹é€šé“é—´ä¿¡æ¯è¿›è¡Œç¼–ç ä»¥è°ƒæ•´ä¸åŒé€šé“çš„é‡è¦æ€§ï¼Œè€Œç›®å°†ç²¾ç¡®çš„ç©ºé—´ç»“æ„ä¿¡æ¯ä¿å­˜åˆ°é€šé“ä¸­ã€‚

å°†ä¸‹é¢çš„EMAä»£ç å¤åˆ¶ç²˜è´´åˆ°common.pyæ–‡ä»¶çš„æœ«å°¾ã€‚

```java
#EMA
class EMA(nn.Module):
    def __init__(self, channels, factor=8):
        super(EMA, self).__init__()
        self.groups = factor # åˆ†ç»„å› å­
        assert channels // self.groups > 0
        self.softmax = nn.Softmax(-1) #softmaxæ“ä½œ
        self.agp = nn.AdaptiveAvgPool2d((1, 1)) # 1Ã—1å¹³å‡æ± åŒ–å±‚
        self.pool_h = nn.AdaptiveAvgPool2d((None, 1)) # Xå¹³å‡æ± åŒ–å±‚ h=1
        self.pool_w = nn.AdaptiveAvgPool2d((1, None)) # Yå¹³å‡æ± åŒ–å±‚ w=1
        self.gn = nn.GroupNorm(channels // self.groups, channels // self.groups) # åˆ†ç»„æ“ä½œ
        self.conv1x1 = nn.Conv2d(channels // self.groups, channels // self.groups, kernel_size=1, stride=1, padding=0) # 1Ã—1å·ç§¯åˆ†æ”¯ 
        self.conv3x3 = nn.Conv2d(channels // self.groups, channels // self.groups, kernel_size=3, stride=1, padding=1) # 3Ã—3å·ç§¯åˆ†æ”¯

    def forward(self, x):
        b, c, h, w = x.size()
        group_x = x.reshape(b * self.groups, -1, h, w)  # b*g,c//g,h,w
        x_h = self.pool_h(group_x) # å¾—åˆ°å¹³å‡æ± åŒ–ä¹‹åçš„h
        x_w = self.pool_w(group_x).permute(0, 1, 3, 2) # å¾—åˆ°å¹³å‡æ± åŒ–ä¹‹åçš„w
        hw = self.conv1x1(torch.cat([x_h, x_w], dim=2)) # å…ˆæ‹¼æ¥ï¼Œç„¶åé€å…¥1Ã—1å·ç§¯
        x_h, x_w = torch.split(hw, [h, w], dim=2)
        x1 = self.gn(group_x * x_h.sigmoid() * x_w.permute(0, 1, 3, 2).sigmoid())
        x2 = self.conv3x3(group_x) # 3Ã—3å·ç§¯åˆ†æ”¯
        x11 = self.softmax(self.agp(x1).reshape(b * self.groups, -1, 1).permute(0, 2, 1))
        x12 = x2.reshape(b * self.groups, c // self.groups, -1)  # b*g, c//g, hw
        x21 = self.softmax(self.agp(x2).reshape(b * self.groups, -1, 1).permute(0, 2, 1))
        x22 = x1.reshape(b * self.groups, c // self.groups, -1)  # b*g, c//g, hw
        weights = (torch.matmul(x11, x12) + torch.matmul(x21, x22)).reshape(b * self.groups, 1, h, w)
        return (group_x * weights.sigmoid()).reshape(b, c, h, w)
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://i-blog.csdnimg.cn/blog_migrate/1dc2e622d45373c0a3318f846d37a1dd.png)

#### ç¬¬â‘¡æ­¥ï¼šåœ¨yolo.pyæ–‡ä»¶é‡Œçš„parse\_modelå‡½æ•°åŠ å…¥ç±»å 

é¦–å…ˆæ‰¾åˆ°yolo.pyé‡Œé¢parse\_modelå‡½æ•°çš„è¿™ä¸€è¡Œã€‚

![](https://i-blog.csdnimg.cn/blog_migrate/9d0d06eae68325dfdc175fd78bb2d8a8.png)

ç„¶åæŠŠåˆšæ‰åŠ å…¥çš„ç±»EMAæ·»åŠ åˆ°è¿™ä¸ªæ³¨å†Œè¡¨é‡Œé¢ï¼š

![](https://i-blog.csdnimg.cn/blog_migrate/9e4442a1fed448c125167fae9b837c8f.png)

#### ç¬¬â‘¢æ­¥ï¼šåˆ›å»ºè‡ªå®šä¹‰çš„yamlæ–‡ä»¶ 

é¦–å…ˆåœ¨modelsæ–‡ä»¶å¤¹ä¸‹å¤åˆ¶yolov5s.yaml æ–‡ä»¶ï¼Œç²˜è´´å¹¶é‡å‘½åä¸º yolov5s\_EMA.yaml

![](https://i-blog.csdnimg.cn/blog_migrate/7e5d68c96c9e4872afedc29f4e2cd861.png)

æ¥ç€ä¿®æ”¹ yolov5s\_EMA.yamlï¼Œå°†EMAæ¨¡å—åŠ åˆ°æˆ‘ä»¬æƒ³æ·»åŠ çš„ä½ç½®ã€‚ è¿™é‡Œå…ˆæ¼”ç¤ºçš„æ˜¯åœ¨Neckç«¯æ·»åŠ ã€‚

å¤åˆ¶ä¸‹é¢ä»£ç ï¼Œç²˜è´´åˆ°åˆšæ‰æ–°åˆ›å»ºçš„yamlæ–‡ä»¶ã€‚

```java
# YOLOv5 ğŸš€ by Ultralytics, GPL-3.0 license

# Parameters
nc: 1  # number of classes
depth_multiple: 0.33  # model depth multiple
width_multiple: 0.50  # layer channel multiple
anchors:
  - [10,13, 16,30, 33,23]  # P3/8
  - [30,61, 62,45, 59,119]  # P4/16
  - [116,90, 156,198, 373,326]  # P5/32

# YOLOv5 v6.0 backbone
backbone:
  # [from, number, module, args]
  [[-1, 1, Conv, [64, 6, 2, 2]],  # 0-P1/2
   [-1, 1, Conv, [128, 3, 2]],  # 1-P2/4
   [-1, 3, C3, [128]],
   [-1, 1, Conv, [256, 3, 2]],  # 3-P3/8
   [-1, 6, C3, [256]],
   [-1, 1, Conv, [512, 3, 2]],  # 5-P4/16
   [-1, 9, C3, [512]],
   [-1, 1, Conv, [1024, 3, 2]],  # 7-P5/32
   [-1, 3, C3, [1024]],
   [-1, 1, SPPF, [1024, 5]],  # 9
  ]

# YOLOv5 v6.0 head
head:
  [[-1, 1, Conv, [512, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 6], 1, Concat, [1]],  # cat backbone P4
   [-1, 3, C3, [512, False]],  # 13

   [-1, 1, Conv, [256, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 4], 1, Concat, [1]],  # cat backbone P3
   [-1, 3, C3, [256, False]],  # 17 (P3/8-small)
   [-1, 1, EMA, [256]],  # åŠ å…¥åˆ°å°ç›®æ ‡å±‚å

   [-1, 1, Conv, [256, 3, 2]],
   [[-1, 14], 1, Concat, [1]],  # cat head P4
   [-1, 3, C3, [512, False]],  # 20 (P4/16-medium)
   [-1, 1, EMA, [512]],  # åŠ å…¥åˆ°ä¸­ç›®æ ‡å±‚å

   [-1, 1, Conv, [512, 3, 2]],
   [[-1, 10], 1, Concat, [1]],  # cat head P5
   [-1, 3, C3, [1024, False]],  # 23 (P5/32-large)
   [-1, 1, EMA, [1024]],  # åŠ å…¥åˆ°å¤§ç›®æ ‡å±‚å

   [[18, 22, 26], 1, Detect, [nc, anchors]],  # Detect(P3, P4, P5)
  ]
```

#### ç¬¬â‘£æ­¥ï¼šéªŒè¯æ˜¯å¦åŠ å…¥æˆåŠŸ 

è¿è¡Œyolo.py

![](https://i-blog.csdnimg.cn/blog_migrate/c6a385e78a405bf180e3a28e431f339d.png)

è¿™æ ·å°±ä¿®æ”¹æˆåŠŸäº†~

#### ç¬¬â‘¤æ­¥ï¼šä¿®æ”¹train.pyä¸­ â€˜--cfgâ€™é»˜è®¤å‚æ•° 

æˆ‘ä»¬å…ˆæ‰¾åˆ° train.py æ–‡ä»¶çš„parse\_optå‡½æ•°ï¼Œç„¶åå°†ç¬¬äºŒè¡Œâ€˜--cfgâ€™çš„defaultæ”¹ä¸ºyolov5s\_EMA.yamlï¼Œç„¶åå°±å¯ä»¥å¼€å§‹è®­ç»ƒå•¦~

![](https://i-blog.csdnimg.cn/blog_migrate/a476d059e7993f9e8a8e442ccbddd888.png)

## ğŸš€ä¸‰ã€åœ¨C3ä¸­æ·»åŠ EMAæ³¨æ„åŠ›æœºåˆ¶æ–¹æ³• 

### 3.1 å…·ä½“æ·»åŠ æ­¥éª¤ 

#### ç¬¬â‘ æ­¥ï¼šåœ¨common.pyä¸­æ·»åŠ C3\_EMAæ¨¡å— 

å°†ä¸‹é¢çš„ä»£ç å¤åˆ¶ç²˜è´´åˆ°common.pyæ–‡ä»¶çš„æœ«å°¾ã€‚

```java
#EMA
class EMA(nn.Module):
    def __init__(self, channels, factor=8):
        super(EMA, self).__init__()
        self.groups = factor # åˆ†ç»„ç‡
        assert channels // self.groups > 0
        self.softmax = nn.Softmax(-1) # Softmax
        self.agp = nn.AdaptiveAvgPool2d((1, 1)) # å¹³å‡æ± åŒ–å±‚
        self.pool_h = nn.AdaptiveAvgPool2d((None, 1)) # xå¹³å‡æ± åŒ–å±‚ h=1
        self.pool_w = nn.AdaptiveAvgPool2d((1, None)) # yå¹³å‡æ± åŒ–å±‚ w=1
        self.gn = nn.GroupNorm(channels // self.groups, channels // self.groups) # åˆ†ç»„æ“ä½œ
        self.conv1x1 = nn.Conv2d(channels // self.groups, channels // self.groups, kernel_size=1, stride=1, padding=0) # 1Ã—1å·ç§¯åˆ†æ”¯
        self.conv3x3 = nn.Conv2d(channels // self.groups, channels // self.groups, kernel_size=3, stride=1, padding=1) # 3Ã—3å·ç§¯åˆ†æ”¯

    def forward(self, x):
        b, c, h, w = x.size()
        group_x = x.reshape(b * self.groups, -1, h, w)  # b*g,c//g,h,w
        x_h = self.pool_h(group_x)
        x_w = self.pool_w(group_x).permute(0, 1, 3, 2)
        hw = self.conv1x1(torch.cat([x_h, x_w], dim=2))
        x_h, x_w = torch.split(hw, [h, w], dim=2)
        x1 = self.gn(group_x * x_h.sigmoid() * x_w.permute(0, 1, 3, 2).sigmoid())
        x2 = self.conv3x3(group_x)
        x11 = self.softmax(self.agp(x1).reshape(b * self.groups, -1, 1).permute(0, 2, 1))
        x12 = x2.reshape(b * self.groups, c // self.groups, -1)  # b*g, c//g, hw
        x21 = self.softmax(self.agp(x2).reshape(b * self.groups, -1, 1).permute(0, 2, 1))
        x22 = x1.reshape(b * self.groups, c // self.groups, -1)  # b*g, c//g, hw
        weights = (torch.matmul(x11, x12) + torch.matmul(x21, x22)).reshape(b * self.groups, 1, h, w)
        return (group_x * weights.sigmoid()).reshape(b, c, h, w)

class C3_EMA3(nn.Module):
    # CSP Bottleneck with 3 convolutions
    def __init__(self, c1, c2, n=1, shortcut=True, g=1, e=0.5):  # ch_in, ch_out, number, shortcut, groups, expansion
        super().__init__()
        c_ = int(c2 * e)  # hidden channels
        self.cv1 = Conv(c1, c_, 1, 1)
        self.cv2 = Conv(c1, c_, 1, 1)
        self.cv3 = Conv(2 * c_, c2, 1)  # optional act=FReLU(c2)
        self.m = nn.Sequential(*(Bottleneck(c_, c_, shortcut, g, e=1.0) for _ in range(n)))
        self.m1 = nn.ModuleList([EMA(2 * c_)])  # æ·»åŠ åœ¨æœ€åä¸€ä¸ªå·ç§¯ä¹‹å‰

    def forward(self, x):
        return self.cv3(self.m1[0](torch.cat((self.m(self.cv1(x)), self.cv2(x)), 1)))


class C3_EMA2(nn.Module):
    # CSP Bottleneck with 3 convolutions
    def __init__(self, c1, c2, n=1, shortcut=True, g=1, e=0.5):  # ch_in, ch_out, number, shortcut, groups, expansion
        super().__init__()
        c_ = int(c2 * e)  # hidden channels
        self.cv1 = Conv(c1, c_, 1, 1)
        self.cv2 = Conv(c1, c_, 1, 1)
        self.cv3 = Conv(2 * c_, c2, 1)  # optional act=FReLU(c2)
        self.m = nn.Sequential(*(Bottleneck(c_, c_, shortcut, g, e=1.0) for _ in range(n)))
        self.m1 = nn.ModuleList([EMA(c1)])  # æ·»åŠ åœ¨æœ€åä¸€ä¸ªå·ç§¯ä¹‹å‰

    def forward(self, x):
        return self.cv3(torch.cat((self.m(self.cv1(x)), self.cv2(self.m1[0](x))), 1))


class C3_EMA1(nn.Module):
    # CSP Bottleneck with 3 convolutions
    def __init__(self, c1, c2, n=1, shortcut=True, g=1, e=0.5):  # ch_in, ch_out, number, shortcut, groups, expansion
        super().__init__()
        c_ = int(c2 * e)  # hidden channels
        self.cv1 = Conv(c1, c_, 1, 1)
        self.cv2 = Conv(c1, c_, 1, 1)
        self.cv3 = Conv(2 * c_, c2, 1)  # optional act=FReLU(c2)
        self.m = nn.Sequential(*(Bottleneck(c_, c_, shortcut, g, e=1.0) for _ in range(n)))
        self.m1 = nn.ModuleList([EMA(c_)])  # æ·»åŠ åœ¨æœ€åä¸€ä¸ªå·ç§¯ä¹‹å‰

    def forward(self, x):
        return self.cv3(torch.cat((self.m(self.m1[0](self.cv1(x))), self.cv2(x)), 1))
```

#### ç¬¬â‘¡æ­¥ï¼šåœ¨yolo.pyæ–‡ä»¶é‡Œçš„parse\_modelå‡½æ•°åŠ å…¥ç±»å 

![](https://i-blog.csdnimg.cn/blog_migrate/14902645b839fdd05aa471d4f08a6bfd.png)

#### ç¬¬â‘¢æ­¥ï¼šåˆ›å»ºè‡ªå®šä¹‰çš„yamlæ–‡ä»¶ 

```java
# YOLOv5 ğŸš€ by Ultralytics, GPL-3.0 license

# Parameters
nc: 80  # number of classes
depth_multiple: 0.33  # model depth multiple
width_multiple: 0.50  # layer channel multiple
anchors:
  - [10,13, 16,30, 33,23]  # P3/8
  - [30,61, 62,45, 59,119]  # P4/16
  - [116,90, 156,198, 373,326]  # P5/32

# YOLOv5 v6.0 backbone
backbone:
  # [from, number, module, args]
  [[-1, 1, Conv, [64, 6, 2, 2]],  # 0-P1/2
   [-1, 1, Conv, [128, 3, 2]],  # 1-P2/4
   [-1, 3, C3_EMA1, [128]],
   [-1, 1, Conv, [256, 3, 2]],  # 3-P3/8
   [-1, 6, C3, [256]],
   [-1, 1, Conv, [512, 3, 2]],  # 5-P4/16
   [-1, 9, C3, [512]],
   [-1, 1, Conv, [1024, 3, 2]],  # 7-P5/32
   [-1, 3, C3, [1024]],
   [-1, 1, SPPF, [1024, 5]],  # 9
  ]

# YOLOv5 v6.0 head
head:
  [[-1, 1, Conv, [512, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 6], 1, Concat, [1]],  # cat backbone P4
   [-1, 3, C3, [512, False]],  # 13

   [-1, 1, Conv, [256, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 4], 1, Concat, [1]],  # cat backbone P3
   [-1, 3, C3, [256, False]],  # 17 (P3/8-small)

   [-1, 1, Conv, [256, 3, 2]],
   [[-1, 14], 1, Concat, [1]],  # cat head P4
   [-1, 3, C3, [512, False]],  # 20 (P4/16-medium)

   [-1, 1, Conv, [512, 3, 2]],
   [[-1, 10], 1, Concat, [1]],  # cat head P5
   [-1, 3, C3, [1024, False]],  # 23 (P5/32-large)

   [[17, 20, 23], 1, Detect, [nc, anchors]],  # Detect(P3, P4, P5)
  ]
```

#### ç¬¬â‘£æ­¥ï¼šéªŒè¯æ˜¯å¦åŠ å…¥æˆåŠŸ 

è¿è¡Œyolo.py

![](https://i-blog.csdnimg.cn/blog_migrate/6f8d549d98b7e000e0ca8b2cadd5d390.png)

> ä»£ç å‚è€ƒï¼š
> 
> [Yolov5/Yolov7æ”¹è¿›---æ³¨æ„åŠ›æœºåˆ¶ï¼šICASSP2023 EMAåŸºäºè·¨ç©ºé—´å­¦ä¹ çš„é«˜æ•ˆå¤šå°ºåº¦æ³¨æ„åŠ›ã€æ•ˆæœä¼˜äºECAã€CBAMã€CA | å°ç›®æ ‡æ¶¨ç‚¹æ˜æ˜¾\_AIå°æ€ªå…½çš„åšå®¢-CSDNåšå®¢][Yolov5_Yolov7_---_ICASSP2023 EMA_ECA_CBAM_CA _ _AI_-CSDN]

#### ç¬¬â‘¤æ­¥ï¼šä¿®æ”¹train.pyä¸­ â€˜--cfgâ€™é»˜è®¤å‚æ•° 

è¿™æ­¥åŒä¸Šï¼Œå°±ä¸å†è¿‡å¤šå™è¿°äº†~

PSï¼š

ï¼ˆ1ï¼‰åœ¨æˆ‘çš„æ•°æ®é›†ä¸Šï¼Œä½¿ç”¨EMAæ¯”CAæ¶¨äº†1.3ï¼Œè¿˜æ˜¯å¾ˆä¸é”™çš„ã€‚

CAï¼š

![](https://i-blog.csdnimg.cn/blog_migrate/6a69b7276acab0773539045f6004e932.png)

EMAï¼š

![](https://i-blog.csdnimg.cn/blog_migrate/6978387b1b3881e402fb85609a6401e8.png)

ï¼ˆ2ï¼‰åœ¨æˆ‘çš„æ•°æ®é›†ä¸Šï¼Œä¸¤ç§æ–¹æ³•ç²¾åº¦å·®ä¸å¤šï¼Œä½†ç¬¬ä¸€ç§æ¯”ç¬¬äºŒç§æ–¹æ³•ç²¾åº¦ç•¥é«˜ä¸€ä¸ã€‚

## ğŸŒŸæœ¬äººYOLOv5ç³»åˆ—å¯¼èˆª 

![962f7cb1b48f44e29d9beb1d499d0530.gif](https://i-blog.csdnimg.cn/blog_migrate/ac3c5d6bfbcbf982e8e9e3632d7f20d1.gif) ğŸ€[YOLOv5æºç ][YOLOv5 1]è¯¦è§£ç³»åˆ—ï¼š

[YOLOv5æºç é€è¡Œè¶…è¯¦ç»†æ³¨é‡Šä¸è§£è¯»ï¼ˆ1ï¼‰â€”â€”é¡¹ç›®ç›®å½•ç»“æ„è§£æ][YOLOv5_1]

[YOLOv5æºç é€è¡Œè¶…è¯¦ç»†æ³¨é‡Šä¸è§£è¯»ï¼ˆ2ï¼‰â€”â€”æ¨ç†éƒ¨åˆ†detect.py][YOLOv5_2_detect.py]

[YOLOv5æºç é€è¡Œè¶…è¯¦ç»†æ³¨é‡Šä¸è§£è¯»ï¼ˆ3ï¼‰â€”â€”è®­ç»ƒéƒ¨åˆ†train.py][YOLOv5_3_train.py]

[YOLOv5æºç é€è¡Œè¶…è¯¦ç»†æ³¨é‡Šä¸è§£è¯»ï¼ˆ4ï¼‰â€”â€”éªŒè¯éƒ¨åˆ†valï¼ˆtestï¼‰.py][YOLOv5_4_val_test_.py]

[YOLOv5æºç é€è¡Œè¶…è¯¦ç»†æ³¨é‡Šä¸è§£è¯»ï¼ˆ5ï¼‰â€”â€”é…ç½®æ–‡ä»¶yolov5s.yaml][YOLOv5_5_yolov5s.yaml]

[YOLOv5æºç é€è¡Œè¶…è¯¦ç»†æ³¨é‡Šä¸è§£è¯»ï¼ˆ6ï¼‰â€”â€”ç½‘ç»œç»“æ„ï¼ˆ1ï¼‰yolo.py][YOLOv5_6_1_yolo.py]

[YOLOv5æºç é€è¡Œè¶…è¯¦ç»†æ³¨é‡Šä¸è§£è¯»ï¼ˆ7ï¼‰â€”â€”ç½‘ç»œç»“æ„ï¼ˆ2ï¼‰common.py][YOLOv5_7_2_common.py]

![962f7cb1b48f44e29d9beb1d499d0530.gif](https://i-blog.csdnimg.cn/blog_migrate/ac3c5d6bfbcbf982e8e9e3632d7f20d1.gif) ğŸ€[YOLOv5å…¥é—¨å®è·µ][YOLOv5 1]ç³»åˆ—ï¼š

[YOLOv5å…¥é—¨å®è·µï¼ˆ1ï¼‰â€”â€”æ‰‹æŠŠæ‰‹å¸¦ä½ ç¯å¢ƒé…ç½®æ­å»º][YOLOv5_1 1]

[YOLOv5å…¥é—¨å®è·µï¼ˆ2ï¼‰â€”â€”æ‰‹æŠŠæ‰‹æ•™ä½ åˆ©ç”¨labelimgæ ‡æ³¨æ•°æ®é›†][YOLOv5_2_labelimg]

[YOLOv5å…¥é—¨å®è·µï¼ˆ3ï¼‰â€”â€”æ‰‹æŠŠæ‰‹æ•™ä½ åˆ’åˆ†è‡ªå·±çš„æ•°æ®é›†][YOLOv5_3]

[YOLOv5å…¥é—¨å®è·µï¼ˆ4ï¼‰â€”â€”æ‰‹æŠŠæ‰‹æ•™ä½ è®­ç»ƒè‡ªå·±çš„æ•°æ®é›†][YOLOv5_4]

[YOLOv5å…¥é—¨å®è·µï¼ˆ5ï¼‰â€”â€”ä»é›¶å¼€å§‹ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ è®­ç»ƒè‡ªå·±çš„ç›®æ ‡æ£€æµ‹æ¨¡å‹ï¼ˆåŒ…å«pyqt5ç•Œé¢ï¼‰][YOLOv5_5_pyqt5]

![](https://i-blog.csdnimg.cn/blog_migrate/c2945744543f6a9cfb94738dc004bfe9.gif)


[YOLOv5_0]: https://blog.csdn.net/weixin_43334693/article/details/130564848?spm=1001.2014.3001.5501
[YOLOv5_1_SE]: https://blog.csdn.net/weixin_43334693/article/details/130551913?spm=1001.2014.3001.5501
[YOLOv5_2_CBAM]: https://blog.csdn.net/weixin_43334693/article/details/130587102?spm=1001.2014.3001.5501
[YOLOv5_3_CA]: https://blog.csdn.net/weixin_43334693/article/details/130619604?spm=1001.2014.3001.5501
[YOLOv5_4_ECA]: https://blog.csdn.net/weixin_43334693/article/details/130641318?spm=1001.2014.3001.5501
[YOLOv5_5_ MobileNetV3]: https://blog.csdn.net/weixin_43334693/article/details/130832933?spm=1001.2014.3001.5501
[YOLOv5_6_ ShuffleNetV2]: https://blog.csdn.net/weixin_43334693/article/details/131008642?spm=1001.2014.3001.5501
[YOLOv5_7_SimAM]: https://blog.csdn.net/weixin_43334693/article/details/131031541?spm=1001.2014.3001.5501
[YOLOv5_8_SOCA]: https://blog.csdn.net/weixin_43334693/article/details/131053284?spm=1001.2014.3001.5501
[YOLOv5_9_EfficientNetv2]: https://blog.csdn.net/weixin_43334693/article/details/131207097?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22131207097%22%2C%22source%22%3A%22weixin_43334693%22%7D
[YOLOv5_10_GhostNet]: https://blog.csdn.net/weixin_43334693/article/details/131235113?spm=1001.2014.3001.5501
[YOLOv5_11_EIoU_AlphaIoU_SIoU_WIoU]: https://blog.csdn.net/weixin_43334693/article/details/131350224?spm=1001.2014.3001.5501
[YOLOv5_12_Neck_BiFPN]: https://blog.csdn.net/weixin_43334693/article/details/131461294?spm=1001.2014.3001.5501
[YOLOv5_13_SiLU_ReLU_ELU_Hardswish_Mish_Softplus_AconC]: https://blog.csdn.net/weixin_43334693/article/details/131513850?spm=1001.2014.3001.5502
[YOLOv5_14_NMS_ DIoU-NMS_CIoU-NMS_EIoU-NMS_GIoU-NMS _SIoU-NMS_Soft-NMS]: https://blog.csdn.net/weixin_43334693/article/details/131552028?spm=1001.2014.3001.5501
[_EMA_]: #%C2%A0%F0%9F%9A%80%E4%B8%80%E3%80%81EMA%E4%BB%8B%E7%BB%8D%C2%A0%C2%A0
[1.1]: #1.1%20%E7%AE%80%E4%BB%8B
[Neck_EMA]: #%F0%9F%9A%80%E4%BA%8C%E3%80%81%E5%9C%A8backbone%E6%9C%AB%E7%AB%AF%E6%B7%BB%E5%8A%A0SimAM%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6%E6%96%B9%E6%B3%95
[2.1 _]: #2.1%20%E6%B7%BB%E5%8A%A0%E9%A1%BA%E5%BA%8F%C2%A0
[2.2 _]: #2.2%20%E5%85%B7%E4%BD%93%E6%B7%BB%E5%8A%A0%E6%AD%A5%E9%AA%A4%C2%A0
[common.py_EMA]: #%E7%AC%AC%E2%91%A0%E6%AD%A5%EF%BC%9A%E5%9C%A8common.py%E4%B8%AD%E6%B7%BB%E5%8A%A0SE%E6%A8%A1%E5%9D%97
[yolo.py_parse_model]: #%C2%A0%E7%AC%AC%E2%91%A1%E6%AD%A5%EF%BC%9A%E5%9C%A8yolo.py%E6%96%87%E4%BB%B6%E9%87%8C%E7%9A%84parse_model%E5%87%BD%E6%95%B0%E5%8A%A0%E5%85%A5%E7%B1%BB%E5%90%8D
[yaml_]: #%E7%AC%AC%E2%91%A2%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84yaml%E6%96%87%E4%BB%B6%C2%A0
[Link 1]: #%C2%A0%E7%AC%AC%E2%91%A3%E6%AD%A5%EF%BC%9A%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E5%8A%A0%E5%85%A5%E6%88%90%E5%8A%9F
[train.py_ _--cfg]: #%E7%AC%AC%E2%91%A4%E6%AD%A5%EF%BC%9A%E4%BF%AE%E6%94%B9train.py%E4%B8%AD%C2%A0%E2%80%98--cfg%E2%80%99%E9%BB%98%E8%AE%A4%E5%8F%82%E6%95%B0
[_C3_EMA]: #%C2%A0%F0%9F%9A%80%E4%B8%89%E3%80%81%E5%9C%A8C3%E4%B8%AD%E6%B7%BB%E5%8A%A0EMA%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6%E6%96%B9%E6%B3%95
[3.1]: #3.1%20%E5%85%B7%E4%BD%93%E6%B7%BB%E5%8A%A0%E6%AD%A5%E9%AA%A4
[common.py_C3_EMA]: #%E7%AC%AC%E2%91%A0%E6%AD%A5%EF%BC%9A%E5%9C%A8common.py%E4%B8%AD%E6%B7%BB%E5%8A%A0C3_EMA%E6%A8%A1%E5%9D%97
[yolo.py_parse_model 1]: #%E7%AC%AC%E2%91%A1%E6%AD%A5%EF%BC%9A%E5%9C%A8yolo.py%E6%96%87%E4%BB%B6%E9%87%8C%E7%9A%84parse_model%E5%87%BD%E6%95%B0%E5%8A%A0%E5%85%A5%E7%B1%BB%E5%90%8D
[Link 2]: #%E7%AC%AC%E2%91%A3%E6%AD%A5%EF%BC%9A%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E5%8A%A0%E5%85%A5%E6%88%90%E5%8A%9F
[YOLOv5]: #%F0%9F%8C%9F%E6%9C%AC%E4%BA%BAYOLOv5%E7%B3%BB%E5%88%97%E5%AF%BC%E8%88%AA
[2305.13563v1_ Efficient Multi-Scale Attention Module with Cross-Spatial Learning _arxiv.org]: https://arxiv.org/abs/2305.13563v1
[Yolov5_Yolov7_---_ICASSP2023 EMA_ECA_CBAM_CA _ _AI_-CSDN]: https://blog.csdn.net/m0_63774211/article/details/131371039?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169320953716800185877967%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=169320953716800185877967&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-20-131371039-null-null.142%5Ev93%5EchatsearchT3_2&utm_term=ema%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6&spm=1018.2226.3001.4187
[YOLOv5 1]: https://so.csdn.net/so/search?q=YOLOv5%E6%BA%90%E7%A0%81&spm=1001.2101.3001.7020
[YOLOv5_1]: https://blog.csdn.net/weixin_43334693/article/details/129356033?spm=1001.2014.3001.5501
[YOLOv5_2_detect.py]: https://blog.csdn.net/weixin_43334693/article/details/129349094?spm=1001.2014.3001.5501
[YOLOv5_3_train.py]: https://blog.csdn.net/weixin_43334693/article/details/129460666?spm=1001.2014.3001.5501
[YOLOv5_4_val_test_.py]: https://blog.csdn.net/weixin_43334693/article/details/129649553?spm=1001.2014.3001.5501
[YOLOv5_5_yolov5s.yaml]: https://blog.csdn.net/weixin_43334693/article/details/129697521?spm=1001.2014.3001.5501
[YOLOv5_6_1_yolo.py]: https://blog.csdn.net/weixin_43334693/article/details/129803802?spm=1001.2014.3001.5501
[YOLOv5_7_2_common.py]: https://blog.csdn.net/weixin_43334693/article/details/129854764?spm=1001.2014.3001.5501
[YOLOv5_1 1]: https://blog.csdn.net/weixin_43334693/article/details/129981848?spm=1001.2014.3001.5501
[YOLOv5_2_labelimg]: https://blog.csdn.net/weixin_43334693/article/details/129995604?spm=1001.2014.3001.5501
[YOLOv5_3]: https://blog.csdn.net/weixin_43334693/article/details/130025866?spm=1001.2014.3001.5501
[YOLOv5_4]: https://blog.csdn.net/weixin_43334693/article/details/130043351?spm=1001.2014.3001.5501
[YOLOv5_5_pyqt5]: https://blog.csdn.net/weixin_43334693/article/details/130044342?spm=1001.2014.3001.5501